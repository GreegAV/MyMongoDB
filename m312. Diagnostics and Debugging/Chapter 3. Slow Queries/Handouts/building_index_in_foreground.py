#!/usr/bin/env python
"""
Simulates an application for the lab, "Building an Index in the Foreground."

Usage:
    ./building_index_in_foreground.py [options]

Options:
    -h --help                   Show this text.
    -p, --port <port>           Port to use [default: 30000]
    -h, --host <host>           Hostname [default: localhost]
    -c, --collection <coll>     Name of the collection to use
                                    [default: employees]
    -d, --dbname <db>           Name of the database [default: m312]
"""
from base64 import b64decode as d;
code="""IiIiClNpbXVsYXRlcyBhbiBhcHBsaWNhdGlvbiBmb3IgdGhlIGxhYiwgIkJ1aWxkaW5nIGFuIEluZGV4IGluIHRoZSBGb3JlZ3JvdW5kLiIKClVzYWdlOgogICAgLi9idWlsZGluZ19pbmRleF9pbl9mb3JlZ3JvdW5kLnB5IFtvcHRpb25zXQoKT3B0aW9uczoKICAgIC1oIC0taGVscCAgICAgICAgICAgICAgICAgICBTaG93IHRoaXMgdGV4dC4KICAgIC0taG9zdCA8aG9zdD4gICAgICAgICAgICAgICBIb3N0bmFtZSBbZGVmYXVsdDogbG9jYWxob3N0XQogICAgLXAsIC0tcG9ydCA8cG9ydD4gICAgICAgICAgIFBvcnQgdG8gdXNlIFtkZWZhdWx0OiAzMDAwMF0KICAgIC1kLCAtLWRibmFtZSA8ZGI+ICAgICAgICAgICBOYW1lIG9mIHRoZSBkYXRhYmFzZSBbZGVmYXVsdDogbTMxMl0KICAgIC1jLCAtLWNvbGxlY3Rpb24gPGNvbGw+ICAgICBOYW1lIG9mIHRoZSBjb2xsZWN0aW9uIHRvIHVzZQogICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICBbZGVmYXVsdDogZW1wbG95ZWVzXQoiIiIKCmZyb20gZGF0ZXRpbWUgaW1wb3J0IGRhdGV0aW1lCmZyb20gbXVsdGlwcm9jZXNzaW5nIGltcG9ydCBQcm9jZXNzCmZyb20gb3MgaW1wb3J0IHN5c3RlbQpmcm9tIHRpbWUgaW1wb3J0IHNsZWVwCgpmcm9tIGRvY29wdCBpbXBvcnQgZG9jb3B0CmZyb20gcHltb25nbyBpbXBvcnQgQVNDRU5ESU5HLCBNb25nb0NsaWVudCwgZXJyb3JzCgoKIyBJZiB5b3UncmUgcmVhZGluZyB0aHJvdWdoIHRoaXMgc2NyaXB0IHRvIGNoZWF0LAojIHlvdSdyZSBvbmx5IGNoZWF0aW5nIHlvdXJzZWxmLgoKZGVmIGluY3JlbWVudF92YWx1ZShob3N0LCBwb3J0LCBkYm5hbWUsIGNvbGxlY3Rpb25fbmFtZSwgZmllbGQ9J2NvdW50ZXInLAogICAgICAgICAgICAgICAgICAgIGJ5PTEsIHByb2Nlc3NfY291bnQ9Tm9uZSk6CiAgICBjbGllbnQgPSBNb25nb0NsaWVudChob3N0PWhvc3QsIHBvcnQ9cG9ydCwgc29ja2V0VGltZW91dE1TPTEwMDApCiAgICBkYiA9IGNsaWVudFtkYm5hbWVdCiAgICBjb2xsZWN0aW9uID0gZGJbY29sbGVjdGlvbl9uYW1lXQogICAgY3VycyA9IGNvbGxlY3Rpb24uZmluZCh7J3Nzbic6IHsnJGV4aXN0cyc6IFRydWV9fSwgeydfaWQnOiAxfSkubGltaXQoMTAwMDApCiAgICBfaWRzID0gW2RvY1snX2lkJ10gZm9yIGRvYyBpbiBjdXJzXQogICAgZm9yIF9pZCBpbiBfaWRzOgogICAgICAgIHRyeToKICAgICAgICAgICAgY29sbGVjdGlvbi51cGRhdGVfb25lKHsnX2lkJzogX2lkfSwgeyckaW5jJzoge2ZpZWxkOiBieX19KQogICAgICAgIGV4Y2VwdCBlcnJvcnMuTmV0d29ya1RpbWVvdXQ6CiAgICAgICAgICAgIHBhc3MKICAgICAgICBzbGVlcCgxKQoKCmRlZiBxdWVyeV9kb2N1bWVudHMoaG9zdCwgcG9ydCwgZGJuYW1lLCBjb2xsZWN0aW9uX25hbWUpOgogICAgY2xpZW50ID0gTW9uZ29DbGllbnQoaG9zdD1ob3N0LCBwb3J0PXBvcnQsIHNvY2tldFRpbWVvdXRNUz0xMDAwKQogICAgZGIgPSBjbGllbnRbZGJuYW1lXQogICAgY29sbGVjdGlvbiA9IGRiW2NvbGxlY3Rpb25fbmFtZV0KICAgIGN1cnMgPSBjb2xsZWN0aW9uLmZpbmQoeydzc24nOiB7JyRleGlzdHMnOiBUcnVlfX0sIHsnX2lkJzogMX0pLmxpbWl0KDEwMDAwKQogICAgX2lkcyA9IFtkb2NbJ19pZCddIGZvciBkb2MgaW4gY3Vyc10KICAgIGZvciBfaWQgaW4gX2lkczoKICAgICAgICB0cnk6CiAgICAgICAgICAgIGN1cnMgPSBjb2xsZWN0aW9uLmZpbmQoeydfaWQnOiBfaWR9KQogICAgICAgICAgICBkb2MgPSBjdXJzLm5leHQoKQogICAgICAgIGV4Y2VwdCBlcnJvcnMuTmV0d29ya1RpbWVvdXQ6CiAgICAgICAgICAgIHBhc3MKICAgICAgICBzbGVlcCgxKQoKCmRlZiB1bnNldF9maWVsZChjb2xsZWN0aW9uLCBmaWVsZD0nY291bnQnKToKICAgIGNvbGxlY3Rpb24udXBkYXRlX21hbnkoe30sIHsnJHVuc2V0Jzoge2ZpZWxkOiAxfX0pCgoKZGVmIG1haW4oKToKICAgIG9wdHMgPSBkb2NvcHQoX19kb2NfXykKICAgIGhvc3QgPSBvcHRzWyctLWhvc3QnXQogICAgcG9ydCA9IGludChvcHRzWyctLXBvcnQnXSkKICAgIGNsaWVudCA9IE1vbmdvQ2xpZW50KHBvcnQ9cG9ydCwgaG9zdD1ob3N0LCBzZXJ2ZXJTZWxlY3Rpb25UaW1lb3V0TVM9NTAwMCkKICAgIGNvbGxlY3Rpb25fbmFtZSA9IG9wdHNbJy0tY29sbGVjdGlvbiddCiAgICBkYm5hbWUgPSBvcHRzWyctLWRibmFtZSddCiAgICBkYiA9IGNsaWVudFtkYm5hbWVdCiAgICBjb2xsZWN0aW9uID0gZGJbY29sbGVjdGlvbl9uYW1lXQogICAgdHJ5OgogICAgICAgIGNvbGxfY291bnQgPSBjb2xsZWN0aW9uLmNvdW50KCkKICAgIGV4Y2VwdCBlcnJvcnMuU2VydmVyU2VsZWN0aW9uVGltZW91dEVycm9yOgogICAgICAgIHByaW50KCJHb3QgYSBTZXJ2ZXJTZWxlY3Rpb25UaW1lb3V0RXJyb3Igd2hpbGUgdHJ5aW5nIHRvIHF1ZXJ5IGEgIiArCiAgICAgICAgICAgICAgInNlcnZlciBhdCAne2hvc3R9Ontwb3J0fScuXG4iLmZvcm1hdChob3N0PWhvc3QsIHBvcnQ9cG9ydCkgKwogICAgICAgICAgICAgICIgIE1vc3QgbGlrZWx5LCB0aGVyZSdzIG5vIHNlcnZlciBsaXN0ZW5pbmcgb24gdGhhdCBwb3J0LlxuIiArCiAgICAgICAgICAgICAgIiAgQXJlIHlvdSBzdXJlIHRoaXMgc2NyaXB0IGlzIHBvaW50ZWQgdG8gYW4gYWN0aXZlIHNlcnZlcj8gXG4iICsKICAgICAgICAgICAgICAiICBZb3UgY2FuIHVzZSAtLWhlbHAgZm9yIG1vcmUgaW5mb3JtYXRpb24uIikKICAgICAgICBleGl0KCkKICAgIGlmIGNvbGxfY291bnQgPT0gMTAxMDg5MzoKICAgICAgICBwcmludCAiTG9va3MgbGlrZSB0aGUgZW1wbG95ZWVzIGNvbGxlY3Rpb24gaXMgYWxyZWFkeSBwcmVzZW50LiIKICAgICAgICBwcmludCAiICBOb3QgZ29pbmcgdG8gcmUtaW1wb3J0IGl0LiIsCiAgICBlbHNlOgogICAgICAgIHByaW50ICJJIGRvbid0IHNlZSB0aGUgZW1wbG95ZWVzIGNvbGxlY3Rpb24uIEltcG9ydGluZyBpdC4gIiwKICAgICAgICBwcmludCAiVGhpcyBtYXkgdGFrZSBhIGJpdCBvZiB0aW1lLiIKICAgICAgICBiYXNoX2NvbW1hbmQgPSAoIm1vbmdvaW1wb3J0IC1kIHtkYm5hbWV9IC1jIHtjb2xsbmFtZX0gLS1kcm9wICIgKwogICAgICAgICAgICAgICAgICAgICAgICAiLS1ob3N0IHtob3N0fSAtLXBvcnQge3BvcnR9IGVtcGxveWVlcy5qc29uIgogICAgICAgICAgICAgICAgICAgICAgICApLmZvcm1hdChkYm5hbWU9ZGJuYW1lLCBjb2xsbmFtZT1jb2xsZWN0aW9uX25hbWUsCiAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgIGhvc3Q9aG9zdCwgcG9ydD1wb3J0KQogICAgICAgIHByaW50ICgiQ2FsbGluZzpcbiAgIiArCiAgICAgICAgICAgICAgICJ7YmFzaF9jb21tYW5kfSBub3ciLmZvcm1hdChiYXNoX2NvbW1hbmQ9YmFzaF9jb21tYW5kKSkKICAgICAgICBzeXN0ZW0oYmFzaF9jb21tYW5kKQogICAgICAgIHByaW50ICJPSywgZG9uZSBpbXBvcnRpbmcgZW1wbG95ZWVzIGFuZCBjb21wYW5pZXMuICIsCgogICAgcHJpbnQgIkRyb3BwaW5nIGluZGV4ZXMuLi4iLAogICAgY29sbGVjdGlvbi5kcm9wX2luZGV4ZXMoKQogICAgcHJpbnQgIiBkb25lLiIKICAgIHByaW50ICJTcGF3bmluZyBhIHNldCBvZiBwcm9jZXNzZXMgdG8gZG8gbG90cyBvZiByZWFkcyBhbmQgd3JpdGVzIHdoaWxlIEkiLAogICAgcHJpbnQgKCJjcmVhdGUgYW4gaW5kZXguIFRoZSBwcm9jZXNzZXMgd2lsbCBzaW11bGF0ZSB5b3VyIG1hbnkgIiArCiAgICAgICAgICAgImFwcGxpY2F0aW9uIGNsaWVudHMuIikKICAgIHByb2Nlc3NlcyA9IFtdCiAgICBmb3IgaSBpbiB4cmFuZ2UoMTApOgogICAgICAgIHcgPSBQcm9jZXNzKHRhcmdldD1pbmNyZW1lbnRfdmFsdWUsCiAgICAgICAgICAgICAgICAgICAgYXJncz0oaG9zdCwgcG9ydCwgZGJuYW1lLCBjb2xsZWN0aW9uX25hbWUpLAogICAgICAgICAgICAgICAgICAgIGt3YXJncz17ImZpZWxkIjogImNvdW50IiwgImJ5IjogMSwgInByb2Nlc3NfY291bnQiOiBpfSkKICAgICAgICBwcm9jZXNzZXMuYXBwZW5kKHcpCiAgICAgICAgciA9IFByb2Nlc3ModGFyZ2V0PXF1ZXJ5X2RvY3VtZW50cywKICAgICAgICAgICAgICAgICAgICBhcmdzPShob3N0LCBwb3J0LCBkYm5hbWUsIGNvbGxlY3Rpb25fbmFtZSkpCiAgICAgICAgcHJvY2Vzc2VzLmFwcGVuZChyKQogICAgICAgIHcuc3RhcnQoKQogICAgICAgIHNsZWVwKDAuMDUpICAjIERvbid0IHN0YXJ0IHRoZW0gYWxsIGF0IG9uY2UuCiAgICAgICAgci5zdGFydCgpCiAgICAgICAgc2xlZXAoMC4wNSkKICAgIHNsZWVwKDUpCiAgICBwcmludCAiICAuLi4gb2suIFdoaWxlIHlvdXIgJ2FwcGxpY2F0aW9uJyBjbGllbnRzIGFyZSBydW5uaW5nLCBJJ20iLAogICAgcHJpbnQgImdvaW5nIHRvIGNyZWF0ZSBhbiBpbmRleCBvbiB7bGFzdF9uYW1lOiAxLCBmaXJzdF9uYW1lOiAxfS4iCiAgICBzbGVlcCgzKQogICAgY29sbGVjdGlvbi5jcmVhdGVfaW5kZXgoWygibGFzdF9uYW1lIiwgQVNDRU5ESU5HKSwKICAgICAgICAgICAgICAgICAgICAgICAgICAgICAoImZpcnN0X25hbWUiLCBBU0NFTkRJTkcpXSkKICAgIHNsZWVwKDEwKQogICAgZm9yIHAgaW4gcHJvY2Vzc2VzOgogICAgICAgIGlmIHAuaXNfYWxpdmUoKToKICAgICAgICAgICAgcC50ZXJtaW5hdGUoKQogICAgc2xlZXAoMSkKICAgIHByaW50ICIgIC4uLiBvaywgZG9uZS4iCiAgICBwcmludCAoIllvdXIgbG9nIGZpbGVzIHNob3VsZCBiZSByZWFkeSBmb3IgeW91IHRvIGxvb2sgYXQhIikKCgppZiBfX25hbWVfXyA9PSAnX19tYWluX18nOgogICAgbWFpbigpCg=="""
eval(compile(d(code), "<string>", 'exec'))
